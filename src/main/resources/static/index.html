<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP服务管理</title>
    <!-- 引入Vue 3 -->
    <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.js"></script>
    <!-- 引入Element Plus -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.3.4/dist/index.css">
    <script src="https://unpkg.com/element-plus@2.3.4/dist/index.full.js"></script>
    <!-- 引入Element Plus Icons -->
    <script src="https://unpkg.com/@element-plus/icons-vue@2.0.10/dist/index.iife.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .card-title {
            font-size: 18px;
            font-weight: bold;
        }
        .card-content {
            margin-bottom: 15px;
        }
        .card-content p {
            margin: 5px 0;
        }
        .card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .form-item {
            margin-bottom: 15px;
        }
        .dialog-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>MCP服务管理</h1>
            <el-button type="primary" @click="openAddDialog">新增MCP服务</el-button>
        </div>

        <!-- MCP服务卡片列表 -->
        <div class="cards-container">
            <div class="card" v-for="server in mcpServers" :key="server.id">
                <div class="card-header">
                    <div class="card-title">{{ server.name }}</div>
                </div>
                <div class="card-content">
                    <p><strong>类型:</strong> {{ server.type }}</p>
                    <p><strong>URL:</strong> {{ server.url }}</p>
                    <p><strong>超时时间:</strong> {{ server.timeout || '默认' }}</p>
                    <div v-if="server.headers && Object.keys(server.headers).length > 0">
                        <p><strong>请求头:</strong></p>
                        <div v-for="(value, key) in server.headers" :key="key">
                            <el-tag size="small">{{ key }}: {{ value }}</el-tag>
                        </div>
                    </div>
                </div>
                <div class="card-actions">
                    <el-button size="small" @click="viewTools(server)">查看工具</el-button>
                    <el-button type="danger" size="small" @click="deleteServer(server)">删除</el-button>
                </div>
            </div>
        </div>

        <!-- 添加MCP服务对话框 -->
        <el-dialog v-model="addDialogVisible" title="添加MCP服务" width="600px">
            <el-tabs v-model="activeTab">
                <el-tab-pane label="表单输入" name="form">
                    <el-form :model="newServer" label-width="100px">
                        <el-form-item label="服务名称">
                            <el-input v-model="newServer.name" required></el-input>
                        </el-form-item>
                        <el-form-item label="服务类型">
                            <el-select v-model="newServer.type" placeholder="请选择服务类型" required>
                                <el-option label="SSE" value="sse"></el-option>
                                <el-option label="HTTP" value="http"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="服务URL">
                            <el-input v-model="newServer.url" placeholder="http://example.com/sse/" required></el-input>
                        </el-form-item>
                        
                        <el-collapse v-model="activeCollapse">
                            <el-collapse-item title="高级配置" name="advanced">
                                <el-form-item label="超时时间(秒)">
                                    <el-input-number v-model="newServer.timeout" :min="1" :max="300"></el-input-number>
                                </el-form-item>
                                <el-form-item label="请求头">
                                    <div v-for="(header, index) in headers" :key="index" style="margin-bottom: 10px;">
                                        <el-input v-model="header.key" placeholder="Header Key" style="width: 40%; margin-right: 10px;"></el-input>
                                        <el-input v-model="header.value" placeholder="Header Value" style="width: 40%;"></el-input>
                                        <el-button type="danger" icon="Delete" @click="removeHeader(index)" circle></el-button>
                                    </div>
                                    <el-button @click="addHeader" type="primary" plain>添加请求头</el-button>
                                </el-form-item>
                            </el-collapse-item>
                        </el-collapse>
                    </el-form>
                </el-tab-pane>
                <el-tab-pane label="JSON输入" name="json">
                    <el-input
                        v-model="jsonInput"
                        type="textarea"
                        :rows="10"
                        placeholder='请输入JSON格式的MCP服务配置，例如：
{
  "name": "user info system",
  "type": "sse",
  "url": "http://127.0.0.1:10002/sse/",
  "timeout": 60,
  "headers": {
    "Authorization": "Bearer 54bfe0d6-803f-4f60-9bed-0d7709731011"
  }
}'
                    ></el-input>
                </el-tab-pane>
            </el-tabs>
            
            <div class="dialog-footer">
                <el-button @click="testConnection">测试连接</el-button>
                <el-button @click="addDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="addServer">确定</el-button>
            </div>
        </el-dialog>

        <!-- 查看工具对话框 -->
        <el-dialog v-model="toolsDialogVisible" :title="'MCP服务工具 - ' + currentServer?.name" width="1200px">
            <div v-if="currentTools.length > 0">
                <el-table :data="currentTools" style="width: 100%" :row-class-name="tableRowClassName">
                    <el-table-column prop="name" label="工具名称" width="200"></el-table-column>
                    <el-table-column prop="shortDescription" label="描述" width="300"></el-table-column>
                    <el-table-column prop="inputSchema" label="输入参数" width="250">
                        <template #default="scope">
                            <pre style="white-space: pre-wrap; word-wrap: break-word;">{{ formatJson(scope.row.inputSchema) }}</pre>
                        </template>
                    </el-table-column>
                    <el-table-column prop="outputSchema" label="返回值" width="250">
                        <template #default="scope">
                            <pre style="white-space: pre-wrap; word-wrap: break-word;">{{ formatJson(scope.row.outputSchema) }}</pre>
                        </template>
                    </el-table-column>
                    <el-table-column label="操作" width="150">
                        <template #default="scope">
                            <el-button size="small" @click="viewToolDetail(scope.row)">查看详情</el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
            <div v-else>
                <p>暂无工具信息</p>
            </div>
            <div class="dialog-footer">
                <el-button @click="toolsDialogVisible = false">关闭</el-button>
            </div>
        </el-dialog>

        <!-- 工具详情对话框 -->
        <el-dialog v-model="toolDetailDialogVisible" :title="'工具详情 - ' + currentTool?.name" width="600px">
            <el-descriptions :column="1" border>
                <el-descriptions-item label="工具名称">{{ currentTool?.name }}</el-descriptions-item>
                <el-descriptions-item label="描述">{{ currentTool?.description }}</el-descriptions-item>
                <el-descriptions-item label="输入参数">
                    <pre>{{ formatJson(currentTool?.inputSchema) }}</pre>
                </el-descriptions-item>
                <el-descriptions-item label="返回值">
                    <pre>{{ formatJson(currentTool?.outputSchema) }}</pre>
                </el-descriptions-item>
            </el-descriptions>
            <div class="dialog-footer">
                <el-button @click="toolDetailDialogVisible = false">关闭</el-button>
            </div>
        </el-dialog>

        <!-- 删除确认对话框 -->
        <el-dialog v-model="deleteDialogVisible" title="确认删除" width="300px">
            <p>确定要删除MCP服务 "{{ serverToDelete?.name }}" 吗？</p>
            <div class="dialog-footer">
                <el-button @click="deleteDialogVisible = false">取消</el-button>
                <el-button type="danger" @click="confirmDelete">确定</el-button>
            </div>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;
        
        const app = createApp({
            setup() {
                // 数据
                const mcpServers = ref([]);
                const addDialogVisible = ref(false);
                const toolsDialogVisible = ref(false);
                const toolDetailDialogVisible = ref(false);
                const deleteDialogVisible = ref(false);
                const activeTab = ref('form');
                const activeCollapse = ref('');
                const jsonInput = ref('');
                const currentServer = ref(null);
                const serverToDelete = ref(null);
                const currentTools = ref([]);
                const currentTool = ref(null);
                
                // 表单数据
                const newServer = reactive({
                    name: '',
                    type: 'sse',
                    url: '',
                    timeout: 60,
                    headers: {}
                });
                
                const headers = ref([{ key: '', value: '' }]);
                
                // 添加请求头
                const addHeader = () => {
                    headers.value.push({ key: '', value: '' });
                };
                
                // 删除请求头
                const removeHeader = (index) => {
                    headers.value.splice(index, 1);
                };
                
                // 获取所有MCP服务
                const fetchServers = async () => {
                    try {
                        const response = await fetch('/api/mcp-servers');
                        mcpServers.value = await response.json();
                    } catch (error) {
                        ElMessage.error('获取MCP服务列表失败: ' + error.message);
                    }
                };
                
                // 打开添加对话框
                const openAddDialog = () => {
                    // 重置表单
                    newServer.name = '';
                    newServer.type = 'sse';
                    newServer.url = '';
                    newServer.timeout = 60;
                    newServer.headers = {};
                    headers.value = [{ key: '', value: '' }];
                    jsonInput.value = '';
                    activeTab.value = 'form';
                    addDialogVisible.value = true;
                };
                
                // 测试连接
                const testConnection = async () => {
                    try {
                        let serverData;
                        
                        if (activeTab.value === 'json') {
                            // JSON输入模式
                            if (!jsonInput.value.trim()) {
                                ElMessage.warning('请输入JSON配置');
                                return;
                            }
                            try {
                                serverData = JSON.parse(jsonInput.value);
                            } catch (e) {
                                ElMessage.error('JSON格式错误: ' + e.message);
                                return;
                            }
                        } else {
                            // 表单输入模式
                            if (!newServer.name || !newServer.type || !newServer.url) {
                                ElMessage.warning('请填写必填字段');
                                return;
                            }
                            
                            // 构造headers对象
                            const headersObj = {};
                            headers.value.forEach(header => {
                                if (header.key && header.value) {
                                    headersObj[header.key] = header.value;
                                }
                            });
                            
                            serverData = {
                                name: newServer.name,
                                type: newServer.type,
                                url: newServer.url,
                                timeout: newServer.timeout,
                                headers: headersObj
                            };
                        }
                        
                        const response = await fetch('/api/mcp-servers/test', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(serverData)
                        });
                        
                        const result = await response.text();
                        if (response.ok) {
                            ElMessage.success('连接测试成功: ' + result);
                        } else {
                            ElMessage.error('连接测试失败: ' + result);
                        }
                    } catch (error) {
                        ElMessage.error('连接测试出错: ' + error.message);
                    }
                };
                
                // 添加MCP服务
                const addServer = async () => {
                    try {
                        let serverData;
                        
                        if (activeTab.value === 'json') {
                            // JSON输入模式
                            if (!jsonInput.value.trim()) {
                                ElMessage.warning('请输入JSON配置');
                                return;
                            }
                            try {
                                serverData = JSON.parse(jsonInput.value);
                            } catch (e) {
                                ElMessage.error('JSON格式错误: ' + e.message);
                                return;
                            }
                        } else {
                            // 表单输入模式
                            if (!newServer.name || !newServer.type || !newServer.url) {
                                ElMessage.warning('请填写必填字段');
                                return;
                            }
                            
                            // 构造headers对象
                            const headersObj = {};
                            headers.value.forEach(header => {
                                if (header.key && header.value) {
                                    headersObj[header.key] = header.value;
                                }
                            });
                            
                            serverData = {
                                name: newServer.name,
                                type: newServer.type,
                                url: newServer.url,
                                timeout: newServer.timeout,
                                headers: headersObj
                            };
                        }
                        
                        const response = await fetch('/api/mcp-servers', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(serverData)
                        });
                        
                        if (response.ok) {
                            ElMessage.success('MCP服务添加成功');
                            addDialogVisible.value = false;
                            fetchServers(); // 刷新列表
                        } else if (response.status === 409) {
                            ElMessage.error('服务名称已存在');
                        } else {
                            ElMessage.error('添加MCP服务失败');
                        }
                    } catch (error) {
                        ElMessage.error('添加MCP服务出错: ' + error.message);
                    }
                };
                
                // 删除MCP服务
                const deleteServer = (server) => {
                    serverToDelete.value = server;
                    deleteDialogVisible.value = true;
                };
                
                // 确认删除
                const confirmDelete = async () => {
                    try {
                        const response = await fetch(`/api/mcp-servers/${serverToDelete.value.id}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            ElMessage.success('MCP服务删除成功');
                            deleteDialogVisible.value = false;
                            fetchServers(); // 刷新列表
                        } else {
                            ElMessage.error('删除MCP服务失败');
                        }
                    } catch (error) {
                        ElMessage.error('删除MCP服务出错: ' + error.message);
                    }
                };
                
                // 查看工具
                const viewTools = async (server) => {
                    currentServer.value = server;
                    try {
                        const response = await fetch(`/api/mcp-servers/${server.id}/tools`);
                        if (response.ok) {
                            const tools = await response.json();
                            // 处理描述字段，只保留 Responses: 之前的内容
                            currentTools.value = tools.map(tool => {
                                return {
                                    ...tool,
                                    shortDescription: tool.description ? tool.description.split('**Responses:**')[0].trim() : ''
                                };
                            });
                        } else {
                            const errorText = await response.text();
                            ElMessage.error('获取工具信息失败: ' + errorText);
                            currentTools.value = [];
                        }
                    } catch (error) {
                        ElMessage.error('获取工具信息出错: ' + error.message);
                        currentTools.value = [];
                    }
                    toolsDialogVisible.value = true;
                };
                
                // 查看工具详情
                const viewToolDetail = (tool) => {
                    currentTool.value = tool;
                    toolDetailDialogVisible.value = true;
                };
                
                // 格式化JSON显示
                const formatJson = (obj) => {
                    if (!obj) return '';
                    try {
                        return JSON.stringify(obj, null, 2);
                    } catch (e) {
                        return obj.toString();
                    }
                };
                
                // 组件挂载时获取数据
                onMounted(() => {
                    fetchServers();
                });
                
                return {
                    mcpServers,
                    addDialogVisible,
                    toolsDialogVisible,
                    toolDetailDialogVisible,
                    deleteDialogVisible,
                    activeTab,
                    activeCollapse,
                    jsonInput,
                    currentServer,
                    serverToDelete,
                    currentTools,
                    currentTool,
                    newServer,
                    headers,
                    addHeader,
                    removeHeader,
                    openAddDialog,
                    testConnection,
                    addServer,
                    deleteServer,
                    confirmDelete,
                    viewTools,
                    viewToolDetail,
                    formatJson,
                    fetchServers
                };
            }
        });
        
        // 注册Element Plus组件
        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>
